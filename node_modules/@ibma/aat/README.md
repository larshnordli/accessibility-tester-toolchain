# Automated Accessibility Tester for NodeJS

## Overview

`@ibma/aat` is a NodeJS Module that allows you to perform integrated accessibility testing within a continuous integration pipeline such as Travis CI.

`@ibma/aat` is a NodeJS module that scans a Selenium WebDriver or parsed document. It allows you to perform integrated accessibility testing within a continuous integration pipeline such as Travis CI while using a variety of test frameworks such as Cucumber, Mocha, or Jasmine. `@ibma/aat` allows users to scan HTML nodes/widgets, URLs, local files, HTML documents, and HTML content in the form of a string. Aside from just performing accessibility scanning, `@ibma/aat` provides a framework to validate accessibility scan results against baseline files and/or simply failing the testcases based on the levels of violations found during the scan.

**Table of Contents**

- [Getting Started](#getting-started)
  - [Prerequisites](#prerequisites)
  - [Install](#install)
    - [Authentication](#authentication)
    - [Install Locally](#install-locally)
    - [Install on Travis CI](#install-on-travis-ci)
      - [Generate Personal Auth Token](#generate-personal-auth-token)
      - [Enabling CI](#enabling-ci)
- [Configuration](#configuration)
  - [Configuring `AAT`](#configuring-aat)
- [Usage](#usage)
- [APIs](#apis)
  - [AAT.getCompliance(`content`, `label`, `callback`)](#aatgetcompliancecontent-label-callback)
  - [AAT.assertCompliance(`actualResults`)](#aatassertcomplianceactualresults)
  - [AAT.getDiffResults(`label`)](#aatgetdiffresultslabel)
  - [AAT.getBaseline(`label`)](#aatgetbaselinelabel)
  - [AAT.diffResultsWithExpected(`actual`, `expected`, `clean`)](#aatdiffresultswithexpectedactual-expected-clean)
  - [AAT.stringifyResults(`results`)](#aatstringifyresultsresults)
- [Errors](#errors)
- [FAQ](#faq)
- [Feedback](#feedback)
  - [Reporting bugs](#reporting-bugs)

## Getting Started

1. Setup and Initialize - Follow the [Prerequisites](#prerequisites) and [Install](#install) instructions.
1. Configure AAT - Follow the [Configuration](#Configuration) instructions.
1. Learn how to use APIs to perform accessibility scans - Refer to [Usage](#usage) and [APIs](#apis) documentation.
1. Give us feedback.

### Prerequisites

1. Install NodeJS and NPM: [via installer](http://w3.hursley.ibm.com/java/jim/ibmsdksfornodejs/ibmsdksfornodejsversion4/index.html)
1. Some testing framework (e.g., mocha, jasmine)
1. Browser automation / parser (e.g., Selenium, Zombie)

### Install

#### Authentication

IBM's npm Enterprise instance is configured to use IBM's GitHub Enterprise SSO (OAuth) authentication, which is a 2 step authentication process.

Login using registry
```console
$ npm login --registry=https://npm-registry.whitewater.ibm.com --scope=@ibma
```

When prompted for `username`, `password`, and `email`, simply provide your w3Id credentials.
After doing so, the npm client will be granted an unresolved token that is stored in your `~/.npmrc` file.

i.e.

```concole
devans@<hostname>:~$ npm login --registry=https://npm-registry.whitewater.ibm.com --scope=@ibma
Username: devans
Password: <w3id passowrd>
Email: (this IS public) devans@ca.ibm.com
Logged in as devans to scope @ibma on https://npm-registry.whitewater.ibm.com/.
```

For more information, visit the npm Enterprise docs: https://npme.npmjs.com/docs/cli/configuration.html#single-sign-on-authentication-saml-oauth-20

#### Install Locally

Perform the steps outlined at [Authentication](#authentication) before trying to install this module.

Install `@ibma/aat` plugin from IBM npm server locally:

```sh
$ npm install @ibma/aat --registry https://npm-registry.whitewater.ibm.com --save-dev
```

Note: The first time you try to install after [Authentication](#authentication) it could fail with the following error message:

> npm ERR! visit https://github.ibm.com/login/oauth/authorize?redirect_uri=...... to validate your session : @ibma/aat

Open this link in your browser, then try again

#### Install on Travis CI

##### Generate Personal Auth Token

To integrate npm Enterprise with Travis CI you need to generate a `.npmrc` file that references IBM's npm Enterprise instance with an authentication token. Follow the instructions outlined at [Authentication](#authentication) and then refer to the steps below.

Look in your `~/.npmrc` file, you will see an entry that looks something like this:

`//npm-registry.whitewater.ibm.com/:_authToken=[NPM_TOKEN]`

Copy `[NPM_TOKEN]` somewhere safe.

##### Enabling CI

Now that you have a token:

* Enable CI for your repo on Travis CI (Whitewater TravisCI is https://travis.ibm.com)
* [Define Variable in Repository Settings](https://docs.travis-ci.com/user/environment-variables#Defining-Variables-in-Repository-Settings) called `NPM_TOKEN` and set this equal to `[NPM_TOKEN]` from [Generate Personal Auth Token](#generate-personal-auth-token)
* Create/update your `.travis.yml` file in your project that looks like this:

    ```yaml
    language: node_js
    node_js:
    - "node"
    before_install:
    - printf "@ibma:registry=https://npm-registry.whitewater.ibm.com/\n//npm-registry.whitewater.ibm.com/:_authToken=${NPM_TOKEN}" >> .npmrc
    ```

* Now in your `package.json` you can simply add the following:

    ```json
    {
      "devDependencies": {
        "@ibma/aat": "^1.1.0"
      }
    }
    ```

For further information, see the official npm Enterprise docs: https://npme.npmjs.com/docs/workflow/travis.html

Note: The first time you try to install it will fail with the following error message:

> npm ERR! visit https://github.ibm.com/login/oauth/authorize?redirect_uri=...... to validate your session : @ibma/aat

Open this link in your browser, then try again.
This will be case inside Travis CI environment as well, but once you have visited the URL it will authenticate your `NPM_TOKEN` so you can continue to use it in TRAVIS CI.

## Configuration

### Configuring `AAT` 

Configuring `AAT` plugin involves constructing a `.aat.yml` file in the project root, which will contain all the configuration
options for `AAT`. Following is the structure of the `.aat.yml` file:

```yml
# optional - Specify the rule pack server to use. (Where to pull the rules and engine from)
# Default: https://cc-rules.w3ibm.mybluemix.net/js/latest/
rulePack: https://cc-rules.w3ibm.mybluemix.net/js/latest/

# optional - Specify one or many policies to scan.
# i.e. For one policy use policies: CI162_5_2_DCP080115
# i.e. Multiple policies: CI162_5_2_DCP080115,CI162_5_2_DCP070116 or refer to below as a list
# Default: null (all policies)
# Refer to README.md FAQ section on details to get the policy ID.
policies:
    - CI162_5_2_DCP070116

# optional - Specify one or many violation levels on which to fail the test
#            i.e. If specified violation then the testcase will only fail if
#                 a violation is found during the scan.
# i.e. failLevels: violation
# i.e. failLevels: violation,potential violation or refer to below as a list
# Default: violation, potentialviolation
failLevels:
    - violation
    - potentialviolation

# optional - Specify one or many violation levels which should be reported
#            i.e. If specified violation then in the report it would only contain
#                 results which are level of violation.
# i.e. reportLevels: violation
# i.e. reportLevels: violation,potentialviolation or refer to below as a list
# Default: violation, potentialviolation, recommendation, potentialrecommendation, manual
reportLevels:
    - violation
    - potentialviolation
    - recommendation
    - potentialrecommendation
    - manual

# Optional - Which type should the results be outputted to
#   outputFormat: json
# Default: json
outputFormat:
    - json

# Optional - Specify labels that you would like associated to your scan
#
# i.e.
#   label: Firefox,master,V12,Linux
#   label:
#       - Firefox
#       - master
#       - V12
#       - Linux
# Default: N/A
label:
    - master

# optional - Where the scan results should be saved.
# Default: results
outputFolder: results

# optional - Where the baseline results should be loaded from
# Default: baselines
baselineFolder: test/baselines

# optional - Should Hidden content be scanned
# true --> Yes scan hidden content
# false --> Don't scan hidden content
# Default: false
checkHiddenContent: false
```

## Usage

Following is how to perform an accessibility scan within your testcases and verifying the scan results:

```javascript
// Perform the accessibility scan using the AAT.getCompliance API
AAT.getCompliance(testDataFileContent, testFile, function (results) {

    // Call the AAT.assertCompliance API which is used to compare the results with baseline object if we can find one that
    // matches the same label which was provided.
    var returnCode = AAT.assertCompliance(results);

    // In the case that the violationData is not defined then trigger an error right away.
    expect(returnCode).toBe(0, "Scanning " + testFile + " failed.");

    // Mark the testcases as done, when using jasmine as the test framework.
    done();
});
```

Refer to [Examples](https://github.ibm.com/IBMa/Tools-Boilerplates/tree/master/Node-AAT) for sample usage scenarios.

## APIs

### AAT.getCompliance(`content`, `label`, `callback`)

Execute accessibility scan on provided content. Content can be in the following form:
* HTML content (String)
* Single node/widget (HTMLElement)
* Local file path (String)
* URL (String)
* Document node (HTMLDocument)
* Selenium WebDriver (WebDriver)

Note: When using Selenium WebDriver the AAT.getCompliance API will only take Selenium WebDriver (WebDriver) instance.

Using a callback mechanism (`callback`) to extract the results and perform assertion using AAT APIs.

* `content` - (String | HTMLElement | HTMLDocument | Selenium WebDriver) content to be scanned for accessibility violations.
* `label` - (String) unique label to identify this accessibility scan from others. Using "/" in the label allows for directory hierarchy when results are saved.
* `callback` - (Function) callback that is invoked (indicating success). The callback will be invoked with the ```results```
as a parameter to the callback function provided. Following is the outline of the results object which will be passed to the callback function:

```javascript
var results = {
    scanID: "12c6717d-69c4-4fe7-ab30-4e16067a0f5a",
    toolID: "@ibma/aat-v1.1.0",
    label: "src/HelloWorld.html",
    URL: "https://www.ibm.com/ca-en/",
    summary: {
        counts: {
            violation: 1,
            potentialviolation: 0,
            recommendation: 0,
            potentialrecommendation: 0,
            manual: 0
        },
        scanTime: 29,
        policies: [
            "CI162_5_2_DCP070116"
        ],
        reportLevels: [
            "violation",
            "potentialviolation",
            "recommendation",
            "potentialrecommendation",
            "manual"
        ],
        startScan: 1470103006149
    },
    reports: [
        {
            frameIdx: 0,
            frameTitle: "Frame 0",
            issues: [
                {
                    severityCode: "eISHigh",
                    messageCode: "wcag20.tech.aria.OrphanedContent",
                    ruleId: "1088",
                    help: "idhi_accessibility_check_g1088.html",
                    msgArgs: [],
                    bounds: {
                        left: 10,
                        top: 11,
                        height: 24,
                        width: 163
                    },
                    level: "violation",
                    xpath: "/html[1]/body[1]/a[1]",
                    snippet: "\<a href='#navskip'\>"
                }
            ]
        }
    ]
}
```

Refer to `actualResults` parameter in [AAT.assertCompliance](#aatassertcomplianceactualresults) API for more details about the properties of results object.

### AAT.assertCompliance(`actualResults`)

Perform assertion on the scan results. Will perform one of the following assertions based on the condition that is met:

1. In the case of a baseline file is provided and available in memory for these scan results, a compare of baseline to `actualResults` will be made. In this case if `actualResults` matches baseline, it returns 0, otherwise returns 1. For this case, assertion is only run on the xpath and ruleId.

2. In the case of NO baseline file is provided for this particular scan, assertion will be made based on the provided `failLevels`. In this case, it returns 2 if there are failures based on failLevels. (violation level matches at least one provided in the `failLevels` object)

* `actualResults` - (Object) results for which assertion needs to be run. Properties include:
  * **scanID**, (String) auto generated UUID used to assoicate a session.
  * **toolID**, (String) tool ID for the tool that generated these results.
  * **label**, (String) label provided to identify unique scans results. (provided through AAT.getCompliance API)
  * **URL**, (String) contains URL when URL was scanned using AAT.getCompliance API. (provided through AAT.getCompliance API)
  * **summary**, (Object) summary of the scan which these results are for. Properties include:
    * **counts**, (Object) number of violations based on the violation level. Properties include:
      * **violation**, (Int) total number of violations.
      * **potentialviolation**, (Int) total number of potential violations.
      * **recommendation**, (Int) total number of recommendation.
      * **potentialrecommendation**, (Int) total number of potential recommendation.
      * **manual**, (Int) total number of manual checks.
    * **scanTime**, (Int) total number of milliseconds it took to perform the scan.
    * **policies**, (Array) policies which were used for this particular scan result.
    * **reportLevels**, (Array) list of violations level on which to report about. (save to file)
    * **startScan**, (Int) start time of the scan in milliseconds since epoch, GMT
  * **reports**, (Array) list of reports in the case of multiple iframes are present on the single page. (iframe scanning not support yet)
    Each array element is an object compromised of the following properties:
    * **frameIdx**, (Int) frame index on the page represented as an integer value.
    * **frameTitle**, (String) title of the frame on the page which was scanned.
    * **issues**, (Array) detailed list of violations. Each array element is an object compromised of the following properties:
      * **severityCode**, (String) severity code for this particular violation.
      * **messageCode**, (String) message code for this particular violation. Used to map the localized message string.
      * **ruleId**, (String) rule ID for this particular violation.
      * **help**, (String) help file name for this particular violation.
      * **msgArgs**, (Array) list of tokens to help provide a detailed error description of the issue.
      * **bounds**, (Object) provides the pixel position of the element on which this violation triggered. Properties include:
        * **left**, (Int) left pixel position of the element.
        * **top**, (Int) top pixel position of the element.
        * **height**, (Int) height pixel position of the element.
        * **width**, (Int) width pixel position of the element.
      * **level**, (String) violation level for this particular violation.
      * **xpath**, (String) xpath to the element on which this particular violation was triggered.
      * **snippet**, (String) snippet for the element on which this particular violation was triggered.

Returns `0` in the case actualResults matches baseline or no violations fall into the failLevels

Returns `1` in the case actualResults DON'T match baseline

Returns `2` in the case that there is a failure based on failLevels.

Returns `-1` in the case that an exception has occured during scanning and the results reflected that.

### AAT.getDiffResults(`label`)

Retrieve the diff results based on label in the case API `AAT.assertCompliance(...)` returns 1, when actualResults DON'T match baseline.

* `label` - (String) label for which to get the diff results for. (should match the one provided for AAT.getCompliance(...))

Returns a diff object, where **left hand side (lhs) is actualResults** and **right hand side (rhs) is baseline**.
Refer to [deep-diff](https://github.com/flitbit/diff#simple-examples) documentation for the format of the diff object,
and how to interpret the object.

Returns `undefined` if there are no differences.

### AAT.getBaseline(`label`)

Retrieve the baseline result object based on the label provided.

* `label` - (String) label for which to get the baseline for. (should match the one provided for AAT.getCompliance(...))

Returns `object` which will follow the same structure as the results object outlined in [AAT.getCompliance](#aatgetcompliancecontent-label-callback)
and [AAT.assertCompliance](#aatassertcomplianceactualresults) APIs.

Returns `undefined` in the case baseline is not found for the label provided.

### AAT.diffResultsWithExpected(`actual`, `expected`, `clean`)

Compare provided `actual` and `expected` objects and get the differences if there are any.

* `actual` - (Object) actual results which need to be compared.
Refer to [AAT.assertCompliance](#aatassertcomplianceactualresults) APIs for details on properties include.
* `expected` - (Object) expected results to compare to.
Refer to [AAT.assertCompliance](#aatassertcomplianceactualresults) APIs for details on properties include.
* `clean` - (boolean) clean the `actual` and `expected` results by converting the objects to match with a basic compliance
compare of only xpath and ruleID

Returns a diff object, where **left hand side (lhs) is actualResults** and **right hand side (rhs) is baseline**.
Refer to [deep-diff](https://github.com/flitbit/diff#simple-examples) documentation for the format of the diff object,
and how to interpret the object.

Returns `undefined` if there are no differences.

### AAT.stringifyResults(`results`)

Retrieve the readable stringified representation of the scan results.

* `results` - (Object) results which need to be stringified.
Refer to [AAT.assertCompliance](#aatassertcomplianceactualresults) APIs for details on properties include.

Returns `String` representation of the scan results which can be logged to console.

## Errors

### Error: labelNotProvided

This is a subtype of `Error` defined by the `AAT` plugin. It is considered a programming error.
`labelNotProvided` is thrown from `AAT.getCompliance(...)` method call when a label is not provided to
function call for the scan that is to be performed. Note: A label must always be provided when calling
`AAT.getCompliance(...)` function.

### Error: labelNotUnique

This is a subtype of `Error` defined by the `AAT` plugin. It is considered a programming error.
`labelNotUnique` is thrown from `AAT.getCompliance(...)` method call when a unique label is not provided to
function call for the scan that is to be performed. Note: Across all accessibility scans the label provided
must always be unique.

## FAQ

* How do I get a list of policies available and their ID's?
   1. Navigate to URL http://ibm.biz/A11yToolsLandingPage
   2. Login using w3id credentials
   3. Once navigated to "Organizations" page either select an existing organization or create a new one
   4. Click on your organization and wait to be naviagated to "Tools" page
   5. Select "Rules" tab to view information about policies
   6. Once on the "Rules" page you can select a policy from the dropdown
   7. Once policy is selected, on the page it will provide description, policy ID to use in CI tools, details on which checkpoints are covers and which rules cover a specific checkpoint.

## Feedback

Feel free to provide any feedback by starting a New Topic in [Forum](https://w3-connections.ibm.com/forums/html/forum?id=11111111-0000-0000-0000-000000005126).

### Reporting bugs

If you think you've found a bug, please report the bug by starting a New Topic in [Forum](https://w3-connections.ibm.com/forums/html/forum?id=11111111-0000-0000-0000-000000005126).
